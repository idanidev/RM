<!-- gym.component.html -->
<div class="gym-container">
  <!-- Mensaje si no hay plan configurado -->
  <div *ngIf="!planConfigurado"
    class="flex flex-column align-items-center justify-content-center"
    style="min-height: 50vh;">
    <i class="pi pi-calendar-plus text-6xl mb-4 text-primary"></i>
    <h2 class="text-center mb-2">¡Configura tu plan de entrenamiento!</h2>
    <p class="text-center text-color-secondary mb-4">
      Selecciona los grupos musculares y días de la semana que quieres entrenar
    </p>
    <p-button
      label="Configurar Plan"
      icon="pi pi-cog"
      size="large"
      (onClick)="abrirConfiguracion()"></p-button>
  </div>

  <!-- Vista con plan configurado -->
  <div *ngIf="planConfigurado" class="flex flex-column flex-1"
    style="min-height: 0;">
    <!-- Header con controles -->
    <div
      class="flex flex-column md:flex-row align-items-stretch md:align-items-center justify-content-between gap-2 mb-2">
      <div class="flex gap-2 flex-wrap">
        <p-button
          [outlined]="vistaActual !== 'semanal'"
          (onClick)="cambiarVista('semanal')"
          styleClass="flex-1 md:flex-none">
          <ng-template pTemplate="content">
            <i class="pi pi-calendar"></i>
            <span class="ml-2">Semanal</span>
          </ng-template>
        </p-button>

        <p-button
          [outlined]="vistaActual !== 'mensual'"
          (onClick)="cambiarVista('mensual')"
          styleClass="flex-1 md:flex-none">
          <ng-template pTemplate="content">
            <i class="pi pi-table"></i>
            <span class="ml-2">Mensual</span>
          </ng-template>
        </p-button>
      </div>

      <p-button
        (onClick)="abrirConfiguracion()"
        [outlined]="true"
        styleClass="w-full md:w-auto">
        <ng-template pTemplate="content">
          <i class="pi pi-cog"></i>
          <span class="ml-2">Reconfigurar</span>
        </ng-template>
      </p-button>
    </div>

    <!-- Vista Semanal -->
    <div *ngIf="vistaActual === 'semanal'" class="vista-semanal">
      <div class="flex align-items-center justify-content-between mb-3">
        <p-button
          icon="pi pi-chevron-left"
          [rounded]="true"
          [text]="true"
          (onClick)="semanaAnterior()"></p-button>

        <h3 class="m-0 text-center flex-1">
          <span class="hidden md:inline">Semana del </span>
          {{ obtenerSemanaActual()[0] | date: 'dd/MM' }}
          <span class="hidden md:inline"> al </span>
          <span class="md:hidden"> - </span>
          {{ obtenerSemanaActual()[6] | date: 'dd/MM/yyyy' }}
        </h3>

        <p-button
          icon="pi pi-chevron-right"
          [rounded]="true"
          [text]="true"
          (onClick)="semanaSiguiente()"></p-button>
      </div>

      <div class="grid">
        <div
          *ngFor="let dia of obtenerSemanaActual(); let i = index"
          class="col-12 sm:col-6 md:col-4 lg:col-3 xl:col">
          <p-card
            class="dia-card h-full"
            [ngClass]="{
              'dia-hoy': esHoy(dia),
              'dia-futuro': esDiaFuturo(dia),
              'dia-completado': obtenerEntrenamientoDia(dia)?.completado
            }"
            (click)="verDetalleEntrenamiento(dia)">
            <ng-template pTemplate="header">
              <div class="dia-header p-2 text-center">
                <!-- Día de la semana responsive -->
                <div class="dia-semana text-sm font-semibold">
                  <span class="md:hidden">{{ diasSemanaCortos[i] }}</span>
                  <span class="hidden md:inline">{{ diasSemana[i] }}</span>
                </div>
                <div class="dia-numero text-3xl font-bold">{{ dia | date: 'd'
                  }}</div>
              </div>
            </ng-template>

            <div class="dia-contenido p-2"
              *ngIf="obtenerEntrenamientoDia(dia) as entrenamiento">
              <div class="flex flex-wrap gap-2 mb-2">
                <span
                  *ngFor="let grupo of entrenamiento.grupos"
                  class="grupo-badge text-xs px-2 py-1 border-round">
                  <!-- Nombres de grupos responsive -->
                  <span class="md:hidden">{{ obtenerNombreCortoGrupo(grupo)
                    }}</span>
                  <span class="hidden md:inline">{{ obtenerNombreGrupo(grupo)
                    }}</span>
                </span>
              </div>

              <div class="flex justify-content-end">
                <p-button
                  [icon]="entrenamiento.completado ? 'pi pi-check-circle' : 'pi pi-circle'"
                  [rounded]="true"
                  [text]="true"
                  [severity]="entrenamiento.completado ? 'success' : 'secondary'"
                  (click)="marcarCompletado(entrenamiento, $event)"></p-button>
              </div>
            </div>

            <div class="dia-vacio p-3 text-center"
              *ngIf="!obtenerEntrenamientoDia(dia)">
              <i class="pi pi-moon text-4xl mb-2 text-400"></i>
              <div class="text-sm text-color-secondary">Descanso</div>
            </div>
          </p-card>
        </div>
      </div>
    </div>

    <!-- Vista Mensual -->
    <div *ngIf="vistaActual === 'mensual'" class="vista-mensual">
      <!-- Header del mes -->
      <div class="flex align-items-center justify-content-between mb-2">
        <p-button
          icon="pi pi-chevron-left"
          [rounded]="true"
          [text]="true"
          (onClick)="mesAnterior()"></p-button>

        <h2 class="m-0 text-center flex-1 text-capitalize font-bold text-xl">
          {{ obtenerNombreMes() }}
        </h2>

        <p-button
          icon="pi pi-chevron-right"
          [rounded]="true"
          [text]="true"
          (onClick)="mesSiguiente()"></p-button>
      </div>

      <!-- Calendario estilo iOS -->
      <div class="calendario-ios">
        <!-- Headers de días responsive -->
        <div class="calendario-ios-header">
          <div *ngFor="let dia of diasSemana; let i = index"
            class="dia-header-ios">
            <span class="md:hidden">{{ diasSemanaCortos[i] }}</span>
            <span class="hidden md:inline">{{ dia }}</span>
          </div>
        </div>

        <!-- Grid de días -->
        <div class="calendario-ios-grid">
          <div
            *ngFor="let dia of obtenerDiasMes()"
            class="dia-celda-ios"
            [ngClass]="{
              'dia-otro-mes': !esMesActual(dia),
              'dia-hoy-ios': esHoy(dia),
              'dia-tiene-entrenamiento': obtenerEntrenamientoDia(dia),
              'dia-completado-ios': obtenerEntrenamientoDia(dia)?.completado
            }"
            (click)="esMesActual(dia) && verDetalleEntrenamiento(dia)">

            <div class="dia-numero-ios">
              {{ dia | date: 'd' }}
            </div>

            <div class="dia-contenido-ios"
              *ngIf="obtenerEntrenamientoDia(dia) as entrenamiento">
              <div class="grupos-iniciales">
                <span
                  *ngFor="let grupo of entrenamiento.grupos"
                  class="grupo-inicial"
                  [ngClass]="{'completado': entrenamiento.completado}"
                  [style.border-bottom-color]="obtenerColorGrupo(grupo)">
                  {{ obtenerInicialesGrupo(grupo) }}
                </span>
              </div>
            </div>

            <div class="dia-sin-entrenamiento"
              *ngIf="!obtenerEntrenamientoDia(dia) && esMesActual(dia)">
              <i class="pi pi-moon"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Drawer de Configuración -->
<p-drawer
  [(visible)]="mostrarConfiguracion"
  position="right"
  [style]="{width: '90vw', 'max-width': '450px'}"
  header="Configurar Plan de Entrenamiento">
  <div class="flex flex-column gap-4 p-3">

    <!-- Paso 1: Grupos musculares -->
    <div class="field">
      <label class="font-bold block mb-2 text-lg">
        1️⃣ ¿Qué grupos musculares?
      </label>
      <p-multiselect
        [(ngModel)]="gruposSeleccionados"
        [options]="gruposMusculares"
        optionLabel="nombre"
        placeholder="Selecciona grupos musculares"
        display="chip"
        styleClass="w-full">
        <ng-template let-option pTemplate="item">
          <div class="flex align-items-center gap-2">
            <div
              class="w-2rem h-2rem border-circle flex align-items-center justify-content-center text-white font-bold"
              [style.background-color]="option.color">
              {{ option.nombreCorto }}
            </div>
            <span>{{ option.nombre }}</span>
          </div>
        </ng-template>
        <ng-template let-value pTemplate="selectedItem">
          <div class="flex align-items-center gap-1">
            <span class="hidden md:inline">{{ value.nombre }}</span>
            <span class="md:hidden">{{ value.nombreCorto }}</span>
          </div>
        </ng-template>
      </p-multiselect>
      <small class="block mt-2 text-color-secondary">
        Selecciona los músculos que trabajarás
      </small>
    </div>

    <!-- Paso 2: Tipo de selección -->
    <div class="field">
      <label class="font-bold block mb-2 text-lg">
        2️⃣ ¿Cómo organizar tus entrenamientos?
      </label>
      <div class="flex flex-column gap-2">
        <div class="flex align-items-center">
          <input
            type="radio"
            id="cantidad"
            value="cantidad-dias"
            [(ngModel)]="tipoSeleccion"
            class="mr-2" />
          <label for="cantidad" class="cursor-pointer">
            Cantidad de días por semana
          </label>
        </div>
        <div class="flex align-items-center">
          <input
            type="radio"
            id="especificos"
            value="dias-especificos"
            [(ngModel)]="tipoSeleccion"
            class="mr-2" />
          <label for="especificos" class="cursor-pointer">
            Días específicos de la semana
          </label>
        </div>
      </div>
    </div>

    <!-- Opción A: Cantidad de días -->
    <div class="field" *ngIf="tipoSeleccion === 'cantidad-dias'">
      <label for="cantidadDias" class="font-bold block mb-2">
        ¿Cuántos días a la semana?
      </label>
      <p-select
        [(ngModel)]="cantidadDias"
        [options]="opcionesDias"
        placeholder="Selecciona días"
        styleClass="w-full" />
      <small class="block mt-2 text-color-secondary">
        El sistema distribuirá automáticamente
      </small>
    </div>

    <!-- Opción B: Días específicos -->
    <div class="field" *ngIf="tipoSeleccion === 'dias-especificos'">
      <label class="font-bold block mb-2">
        ¿Qué días de la semana?
      </label>
      <div class="flex flex-column gap-2">
        <div *ngFor="let dia of diasSemanaOpciones"
          class="flex align-items-center">
          <input
            type="checkbox"
            [id]="'dia-' + dia.valor"
            [value]="dia.valor"
            [(ngModel)]="diasSemanaSeleccionados"
            [checked]="diasSemanaSeleccionados.includes(dia.valor)"
            (change)="onDiaChange(dia.valor, $event)"
            class="mr-2" />
          <label [for]="'dia-' + dia.valor" class="cursor-pointer">
            <span class="hidden md:inline">{{ dia.nombre }}</span>
            <span class="md:hidden">{{ dia.nombreCorto }}</span>
          </label>
        </div>
      </div>
      <small class="block mt-2 text-color-secondary">
        Selecciona los días exactos que entrenarás
      </small>
    </div>

    <!-- Paso 3: Duración -->
    <div class="field">
      <label for="duracionMeses" class="font-bold block mb-2 text-lg">
        3️⃣ ¿Por cuántos meses?
      </label>
      <p-select
        [(ngModel)]="duracionMeses"
        [options]="opcionesMeses"
        placeholder="Selecciona meses"
        styleClass="w-full" />
      <small class="block mt-2 text-color-secondary">
        El plan se generará automáticamente para este periodo
      </small>
    </div>

    <!-- Paso 4: Rutina partida -->
    <div class="field">
      <label class="font-bold block mb-2 text-lg">
        4️⃣ ¿Dividir la rutina?
      </label>
      <div class="flex align-items-center gap-2">
        <input
          type="checkbox"
          id="rutinaPartida"
          [(ngModel)]="rutinaPartida"
          class="mr-2" />
        <label for="rutinaPartida" class="cursor-pointer">
          Dividir en 2 semanas (más descanso entre grupos)
        </label>
      </div>
      <small class="block mt-2 text-color-secondary">
        Si está activado, la rutina se distribuye en 2 semanas en vez de 1,
        dando más tiempo de recuperación
      </small>
    </div>

    <!-- Resumen -->
    <div *ngIf="gruposSeleccionados.length > 0" class="p-3 border-round"
      style="border: 2px solid var(--primary-color); background: var(--primary-50);">
      <div class="font-bold mb-2 text-primary">📋 Resumen de tu plan:</div>
      <ul class="m-0 pl-3">
        <li>{{ gruposSeleccionados.length }} grupos musculares</li>
        <li *ngIf="tipoSeleccion === 'cantidad-dias'">{{ cantidadDias }} días
          por semana</li>
        <li *ngIf="tipoSeleccion === 'dias-especificos'">{{
          diasSemanaSeleccionados.length }} días específicos</li>
        <li>{{ duracionMeses }} {{ duracionMeses === 1 ? 'mes' : 'meses' }}</li>
        <li *ngIf="rutinaPartida">Rutina dividida en 2 semanas ✅</li>
        <li *ngIf="!rutinaPartida">Rutina en 1 semana</li>
      </ul>
    </div>

    <!-- Botones -->
    <div class="flex gap-2 mt-2">
      <p-button
        label="Generar Plan"
        icon="pi pi-check"
        class="flex-1"
        (onClick)="generarPlan()"></p-button>

      <p-button
        label="Cancelar"
        icon="pi pi-times"
        severity="secondary"
        [outlined]="true"
        class="flex-1"
        (onClick)="mostrarConfiguracion = false"></p-button>
    </div>
  </div>
</p-drawer>

<!-- Dialog para ver detalle del día -->
<p-dialog
  [(visible)]="mostrarDetalleDialog"
  [modal]="true"
  [style]="{width: '95vw', 'max-width': '600px'}"
  [breakpoints]="{'960px': '75vw', '640px': '95vw'}"
  [header]="'Entrenamiento - ' + (fechaDiaSeleccionado | date: 'EEEE, d MMMM yyyy')"
  (onHide)="cerrarDetalle()">

  <div *ngIf="diaSeleccionado" class="flex flex-column gap-3">
    <!-- Grupos musculares -->
    <div>
      <h4 class="mt-0 mb-2">Grupos Musculares</h4>
      <div class="flex flex-wrap gap-2">
        <p-card
          *ngFor="let grupo of diaSeleccionado.grupos"
          class="flex-1"
          styleClass="text-center">
          <div class="text-2xl mb-2">💪</div>
          <div class="font-bold">
            <span class="hidden md:inline">{{ obtenerNombreGrupo(grupo)
              }}</span>
            <span class="md:hidden">{{ obtenerNombreCortoGrupo(grupo) }}</span>
          </div>
        </p-card>
      </div>
    </div>

    <!-- Estado -->
    <div class="flex align-items-center gap-3 p-3 border-round surface-border"
      style="border: 1px solid var(--surface-border);">
      <i
        [class]="diaSeleccionado.completado ? 'pi pi-check-circle text-green-500 text-3xl' : 'pi pi-circle text-400 text-3xl'"></i>
      <div class="flex-1">
        <div class="font-bold mb-1">Estado del entrenamiento</div>
        <div class="text-sm text-color-secondary">
          {{ diaSeleccionado.completado ? '✅ Completado' : '⏳ Pendiente' }}
        </div>
      </div>
    </div>

    <!-- Notas -->
    <div>
      <h4 class="mt-0 mb-2">Notas</h4>
      <p class="text-color-secondary m-0">
        Aquí podrás agregar notas sobre tu entrenamiento, peso levantado,
        sensaciones, etc.
        <em>(Próximamente)</em>
      </p>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex gap-2 justify-content-between flex-wrap">
      <p-button
        [label]="diaSeleccionado?.completado ? 'Marcar Pendiente' : 'Marcar Completado'"
        [icon]="diaSeleccionado?.completado ? 'pi pi-circle' : 'pi pi-check'"
        [severity]="diaSeleccionado?.completado ? 'secondary' : 'success'"
        class="flex-1"
        (onClick)="diaSeleccionado && marcarCompletado(diaSeleccionado); cerrarDetalle()"></p-button>

      <p-button
        label="Cerrar"
        icon="pi pi-times"
        [outlined]="true"
        class="flex-1"
        (onClick)="cerrarDetalle()"></p-button>
    </div>
  </ng-template>
</p-dialog>

<p-toast></p-toast>
